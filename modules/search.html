<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>教材タイトル検索（全体）</title>
<link rel="icon" href="/anki-project/assets/img/favicon.png" type="image/png">
<style>
  :root{
    --bg:#0b1220;--card:#121a2b;--fg:#e6ebff;--muted:#a5b4fc;--pill:#1f2a44;--accent:#6366f1;
    --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--chip:#0e1729;--border:#22304d
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif}
  header.site{padding:16px 20px;border-bottom:1px solid var(--border)}
  header h1{margin:0;font-size:20px}
  .wrap{max-width:1080px;margin:0 auto;padding:18px}
  .searchbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
  .searchbar input[type=search]{flex:1 1 360px;background:#0e1730;border:1px solid var(--border);color:var(--fg);padding:12px 12px;border-radius:12px;outline:none}
  .searchbar input[type=search]::placeholder{color:#8ea2d6}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--pill);color:#c7d2fe;font-size:12px;margin-right:6px;border:1px solid var(--border)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:block;color:inherit;text-decoration:none}
  .card:hover{outline:2px solid #334155}
  .card h3{margin:0 0 6px 0;font-size:16px;line-height:1.4}
  .muted{color:#9aa9d8;font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .empty{opacity:.8;border:1px dashed var(--border);border-radius:16px;padding:24px;text-align:center}
  .count{font-size:12px;color:#cbd5e1}
  .hide{display:none}
  footer{opacity:.8;padding:18px;text-align:center;color:#89a1d9;font-size:12px}
  .sr{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
<header class="site"><h1>🔎 教材タイトル検索（全体横断）</h1></header>
<main class="wrap">
  <div class="searchbar">
    <label for="q" class="sr">検索</label>
    <input id="q" type="search" placeholder="タイトルで検索（例：九州／電気／多角形）」 autofocus>
    <div class="count" id="count">読み込み中…</div>
  </div>
  <div class="grid" id="list"></div>
  <div id="empty" class="empty hide">該当するタイトルがありません。</div>
</main>
<footer>データソース：各科目 manifest.json（html / marker / noimg / img）</footer>
<script>
(async()=>{
  const SUBJECTS = [
    {key:'jp',  label:'国語'},
    {key:'math',label:'算数'},
    {key:'sci', label:'理科'},
    {key:'geo', label:'社会'}
  ];
  const listEl = document.getElementById('list');
  const countEl = document.getElementById('count');
  const emptyEl = document.getElementById('empty');
  const qEl = document.getElementById('q');

  const toAbs=(raw)=>{
    if(!raw) return '#';
    if(/^https?:\/\//.test(raw)) return raw;
    if(raw.startsWith('/anki-project/')) return raw;
    if(raw.startsWith('/')) return '/anki-project'+raw;
    return '/anki-project/'+raw.replace(/^\.?\//,'');
  };

  const fetchJSON = async (url)=>{
    const r = await fetch(url+'?t='+Date.now(), {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status+' '+url);
    return r.json();
  };

  // 正規化（全角・ひら→カナをゆるく）
  const normalize = (s)=>{
    if(!s) return '';
    // 全角→半角、記号間引き（簡易）
    const z2h = s.replace(/[！-～]/g, ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0))
                 .replace(/　/g,' ');
    // ひら→カタカナ
    return z2h.replace(/[ぁ-ゖ]/g, ch=>String.fromCharCode(ch.charCodeAt(0)+0x60)).toLowerCase();
  };

  // 1) 各科目の manifest.json を取得
  async function loadAll(){
    const all=[];
    for(const subj of SUBJECTS){
      const url = `/anki-project/assets/data/${subj.key}/manifest.json`;
      try{
        const d = await fetchJSON(url);
        const arr = Array.isArray(d) ? d : (d.modules || []);
        for(const it of arr){
          // title, type, path の正規化
          const item = {
            title: it.title || '(無題)',
            type: it.type || (String(it.path||'').includes('marker.html')?'marker':'html'),
            path: toAbs(it.path || it.url || it.data || '#'),
            updated: it.updated || '',
            subject: subj.label
          };
          all.push(item);
        }
      }catch(e){
        console.warn('manifest load failed:', url, e);
      }
    }
    return all;
  }

  function render(items){
    listEl.innerHTML='';
    const frag=document.createDocumentFragment();
    for(const m of items){
      const a=document.createElement('a');
      a.className='card'; a.href=m.path; a.target='_self';
      const typeLabel = m.type==='marker' ? 'marker（図あり）' : (m.type==='noimg' ? 'noimg（図なし）' : (m.type==='img' ? 'img（地図/図）':'HTML'));
      const updated = m.updated ? new Date(m.updated).toLocaleDateString('ja-JP') : '';
      a.innerHTML = `
        <h3>${m.title}</h3>
        <div class="row">
          <span class="pill">${m.subject}</span>
          <span class="pill">${typeLabel}</span>
          ${updated?`<span class="pill muted">更新:${updated}</span>`:''}
        </div>
      `;
      frag.appendChild(a);
    }
    listEl.appendChild(frag);
    emptyEl.classList.toggle('hide', items.length!==0);
    countEl.textContent = `${items.length} 件`;
  }

  // データ読み込み
  const ALL = await loadAll();
  // img/mapdata など type の補正（後から来たものを上書き）
  for(const it of ALL){
    if(/\/modules\/img\.html/.test(it.path)) it.type='img';
    if(/\/modules\/noimg\.html/.test(it.path)) it.type='noimg';
  }

  // URLの ?q= 反映
  const params = new URLSearchParams(location.search);
  if(params.get('q')) qEl.value = params.get('q');

  // フィルタ処理
  const idx = ALL.map(x=>({norm:normalize(x.title), i:x}));
  const doFilter = ()=>{
    const kw = normalize(qEl.value.trim());
    if(!kw){ render(ALL); return; }
    const hits = idx.filter(r=>r.norm.includes(kw)).map(r=>r.i);
    render(hits);
  };
  qEl.addEventListener('input', ()=>{
    // 軽いデバウンス
    clearTimeout(qEl._t); qEl._t=setTimeout(doFilter, 80);
  }, {passive:true});

  // 初期表示
  doFilter();
})();
</script>
</body>
</html>
