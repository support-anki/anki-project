<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>図あり教材（共通テンプレート・正誤記録対応）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #222;
      --muted: #667085;
      --brand: #3b4675;
      --accent: #06C755;
      --danger: #ef4444;
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--text); }
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(6px); background: rgba(255,255,255,0.9); border-bottom: 1px solid #e5e7eb; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 12px 16px; }
    .title { font-size: 18px; font-weight: 700; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 8px; }
    .pill { display: inline-flex; align-items: center; gap: 4px; border: 1px solid #ddd; background: #fff; border-radius: 999px; padding: 6px 10px; font-size: 13px; }
    .btn { cursor: pointer; border: 1px solid #ddd; border-radius: 8px; padding: 6px 10px; font-size: 14px; background: #fff; }
    .btn.primary { background: var(--brand); color: #fff; border-color: var(--brand); }
    .btn.ghost { background: transparent; }
    .layout { display: grid; grid-template-columns: 1fr 380px; gap: 12px; margin: 12px auto; max-width: 1200px; padding: 0 16px 24px; }
    #map { width: 100%; height: calc(100vh - 150px); border-radius: 12px; background: #e9edf3; }
    aside { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; display: flex; flex-direction: column; }
    .aside-head { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab { border: 1px solid #ddd; border-radius: 999px; padding: 6px 10px; font-size: 13px; cursor: pointer; }
    .tab.active { background: var(--brand); color: #fff; border-color: var(--brand); }
    .aside-body { padding: 12px; overflow: auto; display: grid; gap: 10px; }
    .qitem { border: 1px solid #ddd; border-radius: 10px; padding: 8px; background: #fff; }
    .qitem.correct { border-color: #22c55e; background: #f0fff4; }
    .qitem.wrong { border-color: #ef4444; background: #fff5f5; }
    .qtop { display: flex; justify-content: space-between; align-items: center; }
    .qid { font-weight: 700; }
    .status { display: flex; gap: 6px; align-items: center; }
    .chip { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; }
    .chip.ok { background: #dcfce7; border-color: #86efac; }
    .chip.bad { background: #fee2e2; border-color: #fca5a5; }
    .answer { background: #f8fafc; border: 1px dashed #d8dee9; border-radius: 8px; padding: 8px; font-size: 14px; }
    .num-marker { width: 28px; height: 28px; border-radius: 50%; display: grid; place-items: center; font-weight: 700; border: 2px solid #fff; background: #64748b; color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    .num-marker.ok { background: var(--accent); }
    .num-marker.bad { background: var(--danger); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title" id="pageTitle">図あり教材</div>
      <div class="toolbar">
        <span class="pill"><input type="checkbox" id="toggleAnswers" /> <label for="toggleAnswers">答えを常に表示</label></span>
        <span class="pill"><input type="checkbox" id="toggleLabels" checked /> <label for="toggleLabels">番号ラベルを表示</label></span>
        <button class="btn" id="fitBtn">全体表示</button>
        <button class="btn" id="resetBtn">未表示にリセット</button>
        <button class="btn" id="exportBtn">JSONをコピー</button>
        <button class="btn" id="editBtn">編集モード</button>
      </div>
    </div>
  </header>
  <main class="layout">
    <div id="map"></div>
    <aside>
      <div class="aside-head">
        <div class="tabs" id="imgTabs"></div>
        <div class="hint" id="counter">—</div>
      </div>
      <div class="aside-body" id="qList"></div>
    </aside>
  </main>
  <div class="footer" style="text-align:center;color:#888;font-size:12px;">番号をクリックして答えを確認。正誤は端末に保存されます。</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  const qs = new URLSearchParams(location.search);
  const dataUrl = qs.get('data');
  const title = qs.get('title') || '図あり教材';
  document.getElementById('pageTitle').textContent = title;
  const els = {
    qList: document.getElementById('qList'),
    tabs: document.getElementById('imgTabs'),
    fit: document.getElementById('fitBtn'),
    reset: document.getElementById('resetBtn'),
    exportBtn: document.getElementById('exportBtn'),
    toggleAnswers: document.getElementById('toggleAnswers'),
    toggleLabels: document.getElementById('toggleLabels'),
    counter: document.getElementById('counter')
  };
  const map = L.map('map', { crs: L.CRS.Simple, minZoom: -4 });
  const state = { data:null, activeImgId:null, markers:{}, results:{}, revealed:new Set() };
  function storeKey(k){return `anki-img:${dataUrl}:${k}`;}
  state.results = JSON.parse(localStorage.getItem(storeKey('results'))||'{}');
  state.revealed = new Set(JSON.parse(localStorage.getItem(storeKey('revealed'))||'[]'));
  fetch(dataUrl).then(r=>r.json()).then(j=>{state.data=j;setupImages(j.images);setupMarkers(j.points);renderList();fitActive();});
  function setupImages(images){images.forEach((img,i)=>{const b=[[0,0],[img.height,img.width]];const layer=L.imageOverlay(img.src,b).addTo(map);state.imageLayers=state.imageLayers||{};state.imageLayers[img.id]={layer,bounds:b};if(i==0){state.activeImgId=img.id;map.fitBounds(b);}const t=document.createElement('button');t.className='tab'+(i==0?' active':'');t.textContent=img.label||img.id;t.onclick=()=>setActiveImage(img.id);els.tabs.appendChild(t);});}
  function setActiveImage(id){state.activeImgId=id;Object.entries(state.imageLayers).forEach(([k,v])=>{if(k===id){v.layer.addTo(map);}else{map.removeLayer(v.layer);}});refreshMarkers();renderList();fitActive();}
  function fitActive(){const cur=state.imageLayers[state.activeImgId];if(cur)map.fitBounds(cur.bounds);}
  function setupMarkers(points){points.forEach(pt=>{const m=L.marker([pt.y,pt.x],{icon:makeIcon(pt)}).addTo(map);m.on('click',()=>toggleReveal(pt.id));state.markers[pt.id]=m;});refreshMarkers();}
  function makeIcon(pt){const res=state.results[pt.id];let cls='num-marker';if(res==='correct')cls+=' ok';if(res==='wrong')cls+=' bad';const num=els.toggleLabels.checked?pt.id:'';return L.divIcon({html:`<div class="${cls}">${num}</div>`,className:'',iconSize:[28,28],iconAnchor:[14,14]});}
  function refreshMarkers(){Object.entries(state.markers).forEach(([id,m])=>{const pt=state.data.points.find(p=>p.id===id);if(pt.img===state.activeImgId){m.addTo(map);}else{map.removeLayer(m);}m.setIcon(makeIcon(pt));});}
  function renderList(){const active=state.activeImgId;const always=els.toggleAnswers.checked;const list=state.data.points.filter(p=>p.img===active);els.qList.innerHTML='';list.forEach(pt=>{const shown=always||state.revealed.has(pt.id);const res=state.results[pt.id];const card=document.createElement('div');card.className='qitem'+(res==='correct'?' correct':res==='wrong'?' wrong':'');card.innerHTML=`<div class="qtop"><div class="status"><span class="qid">${pt.id}</span>${res==='correct'?'<span class="chip ok">✅正解</span>':res==='wrong'?'<span class="chip bad">❌誤答</span>':''}</div><div class="qactions"><button class="btn" data-a="reveal">${shown?'隠す':'表示'}</button><button class="btn ghost" data-a="ok">✅</button><button class="btn ghost" data-a="ng">❌</button></div></div><div class="answer" ${shown?'':'style="display:none"'}>${pt.answer??pt.label??''}</div>`;card.querySelector('[data-a="reveal"]').onclick=()=>toggleReveal(pt.id);card.querySelector('[data-a="ok"]').onclick=()=>mark(pt.id,'correct',card);card.querySelector('[data-a="ng"]').onclick=()=>mark(pt.id,'wrong',card);els.qList.appendChild(card);});}
  function toggleReveal(id){if(state.revealed.has(id))state.revealed.delete(id);else state.revealed.add(id);save();renderList();}
  function mark(id,res,card){state.results[id]=res;save();renderList();}
  function save(){localStorage.setItem(storeKey('revealed'),JSON.stringify([...state.revealed]));localStorage.setItem(storeKey('results'),JSON.stringify(state.results));}
  </script>
</body>
</html>
