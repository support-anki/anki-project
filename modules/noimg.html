<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å›³ãªã—æ•™æï¼ˆå¤§ããªæ–‡å­—ç‰ˆï¼‰</title>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #667085;
      --brand: #3b4675;
      --ok: #22c55e;
      --ng: #ef4444;
      --border: #e5e7eb;
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Yu Gothic", Meiryo, sans-serif; color: var(--ink); background: var(--bg); }
    /* ğŸ‘€ å¤§ããªæ–‡å­—ãƒ»åºƒã‚ã®è¡Œé–“ */
    body { font-size: 18px; line-height: 1.7; }

    header { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(6px); background: rgba(255,255,255,0.92); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 960px; margin: 0 auto; padding: 14px 16px; }
    .title { font-size: 20px; font-weight: 800; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 999px; background: #fff; font-size: 0.95em; }

    .btn { cursor: pointer; border: 1px solid var(--border); background: #fff; border-radius: 12px; padding: 10px 14px; font-size: 1rem; }
    .btn.primary { background: var(--brand); color: #fff; border-color: var(--brand); }
    .btn.ghost { background: transparent; }

    main { max-width: 960px; margin: 12px auto 24px; padding: 0 16px; display: grid; gap: 14px; }

    .qcard { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; display: grid; gap: 10px; }
    .qtop { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .qid { font-weight: 800; letter-spacing: 0.02em; }
    .note { color: var(--muted); font-size: 0.95em; }

    .qtext { font-size: 1.1em; }
    .choices { display: grid; gap: 8px; }
    .choiceRow { display: grid; gap: 8px; }

    .choice { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: #fff; cursor: pointer; user-select: none; }
    .choice input { width: 20px; height: 20px; }

    .result { display: none; border: 1px dashed var(--border); background: #f8fafc; border-radius: 12px; padding: 10px; }
    .qcard.correct { border-color: #bbf7d0; background: #f0fff4; }
    .qcard.wrong { border-color: #fecaca; background: #fff5f5; }

    .chips { display: inline-flex; gap: 6px; align-items: center; }
    .chip { font-size: 0.9em; padding: 2px 10px; border-radius: 999px; border: 1px solid var(--border); background: #f1f5f9; }
    .chip.ok { background: #dcfce7; border-color: #86efac; }
    .chip.bad { background: #fee2e2; border-color: #fca5a5; }

    footer { text-align: center; color: #94a3b8; font-size: 0.95em; padding: 6px 0 20px; }

    @media (max-width: 640px) {
      .title { font-size: 19px; }
      .btn { padding: 10px 12px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title" id="pageTitle">å›³ãªã—æ•™æ</div>
      <div class="toolbar" role="toolbar" aria-label="æ“ä½œ">
        <span class="pill"><input type="checkbox" id="shuffle"> <label for="shuffle">ãªã‚‰ã¹ã‹ãˆ</label></span>
        <span class="pill"><input type="checkbox" id="voice"> <label for="voice">ã‚ˆã¿ã‚ã’</label></span>
        <button class="btn" id="resetBtn">ã‚Šã‚Œãã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </header>

  <main id="list" aria-live="polite"></main>
  <footer>ãˆã‚‰ã‚“ã§ç­”ãˆã‚ˆã†ã€‚ã¾ã¡ãŒãˆãŸå•é¡Œã¯ã‚‚ã†ä¸€åº¦ã¨ã‘ã¾ã™ã€‚</footer>

  <script>
  // ---- è¨­å®š ----
  const qs = new URLSearchParams(location.search);
  const dataUrl = qs.get('data');
  const title = qs.get('title') || 'å›³ãªã—æ•™æ';
  const shuffleQS = qs.get('shuffle') === 'true';
  const voiceQS = qs.get('voice') === 'true';
  document.getElementById('pageTitle').textContent = title;

  const els = {
    list: document.getElementById('list'),
    shuffle: document.getElementById('shuffle'),
    voice: document.getElementById('voice'),
    reset: document.getElementById('resetBtn')
  };
  els.shuffle.checked = shuffleQS;
  els.voice.checked = voiceQS;

  // ---- LocalStorage Keys ----
  const key = (k)=>`anki-noimg:${dataUrl}:${k}`;
  let results = JSON.parse(localStorage.getItem(key('results')) || '{}'); // {id:'correct'|'wrong'}

  // ---- èª­ã¿è¾¼ã¿ ----
  fetch(dataUrl, { cache: 'no-store' })
    .then(r => { if(!r.ok) throw new Error(r.status); return r.json(); })
    .then(json => init(json))
    .catch(err => { console.error(err); alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); });

  function init(data){
    if(data.title) document.getElementById('pageTitle').textContent = data.title;
    let items = Array.isArray(data.items) ? data.items.slice() : [];
    if (els.shuffle.checked) items = shuffle(items);
    render(items);
  }

  function render(items){
    els.list.innerHTML = '';
    items.forEach(it => {
      const card = document.createElement('section');
      card.className = 'qcard' + (results[it.id]==='correct' ? ' correct' : results[it.id]==='wrong' ? ' wrong' : '');
      card.setAttribute('data-id', it.id);

      const qtop = document.createElement('div');
      qtop.className = 'qtop';
      qtop.innerHTML = `<div class="chips"><span class="qid">#${it.id}</span>${badge(results[it.id])}</div>`;

      const qtext = document.createElement('div');
      qtext.className = 'qtext';
      qtext.textContent = it.q;

      const choicesWrap = document.createElement('div');
      choicesWrap.className = 'choices';

      if (Array.isArray(it.choices) && it.choices.length){
        const grp = document.createElement('div');
        grp.className = 'choiceRow';
        it.choices.forEach((c, idx) => {
          const row = document.createElement('label');
          row.className = 'choice';
          row.innerHTML = `<input type="radio" name="q_${it.id}" value="${idx}"><div class="ctext">${c}</div>`;
          row.addEventListener('click', (e)=>onChoose(it, idx, card));
          grp.appendChild(row);
        });
        choicesWrap.appendChild(grp);
      }

      const result = document.createElement('div');
      result.className = 'result';
      result.innerHTML = `<div>ã“ãŸãˆï¼š<strong>${(it.answers && it.answers[0]) || ''}</strong></div>${it.note ? `<div class="note">${it.note}</div>` : ''}`;

      const actions = document.createElement('div');
      actions.className = 'actions';
      actions.innerHTML = `
        <button class="btn" data-a="reveal">ã“ãŸãˆ</button>
        <button class="btn ghost" data-a="ok">âœ…</button>
        <button class="btn ghost" data-a="ng">âŒ</button>
      `;

      actions.querySelector('[data-a="reveal"]').addEventListener('click', ()=>toggleResult(result));
      actions.querySelector('[data-a="ok"]').addEventListener('click', ()=>mark(card, 'correct'));
      actions.querySelector('[data-a="ng"]').addEventListener('click', ()=>mark(card, 'wrong'));

      card.appendChild(qtop);
      card.appendChild(qtext);
      card.appendChild(choicesWrap);
      card.appendChild(actions);
      card.appendChild(result);
      els.list.appendChild(card);
    });
  }

  function badge(state){
    if (state==='correct') return '<span class="chip ok">âœ… æ­£è§£</span>';
    if (state==='wrong') return '<span class="chip bad">âŒ èª¤ç­”</span>';
    return '';
  }

  function toggleResult(el){ el.style.display = (el.style.display==='block') ? 'none' : 'block'; }

  function onChoose(item, idx, card){
    const correctSet = new Set(item.answers || []);
    const text = (item.choices && item.choices[idx]) || '';
    const isCorrect = correctSet.has(text) || correctSet.has(String(idx)) || correctSet.has(String.fromCharCode(0x30A2 + idx)); // idx or ã‚¢/ã‚¤/ã‚¦/ã‚¨ å¯¾å¿œ
    mark(card, isCorrect ? 'correct' : 'wrong');
    if (els.voice.checked) speakSentence(`${isCorrect ? 'ã›ã„ã‹ã„' : 'ã¡ãŒã†ã‚ˆ'}`);
  }

  function mark(card, state){
    const id = card.getAttribute('data-id');
    results[id] = state; save();
    card.classList.toggle('correct', state==='correct');
    card.classList.toggle('wrong', state==='wrong');
    const chips = card.querySelector('.chips');
    if (chips){ chips.innerHTML = `<span class="qid">#${id}</span>${badge(state)}`; }
  }

  function save(){ localStorage.setItem(key('results'), JSON.stringify(results)); }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  // èª­ã¿ä¸Šã’ï¼ˆç°¡æ˜“ï¼‰
  function speakSentence(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }

  // UIã‚¤ãƒ™ãƒ³ãƒˆ
  els.reset.addEventListener('click', ()=>{ if(confirm('æ­£èª¤ã®ã‚Šã‚Œãã‚’ãœã‚“ã¶æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')){ results={}; save(); location.reload(); } });
  els.shuffle.addEventListener('change', ()=>{ const url=new URL(location.href); url.searchParams.set('shuffle', els.shuffle.checked?'true':'false'); location.href=url.toString(); });
  els.voice.addEventListener('change', ()=>{ const url=new URL(location.href); url.searchParams.set('voice', els.voice.checked?'true':'false'); history.replaceState(null, '', url.toString()); });
  </script>
</body>
</html>
