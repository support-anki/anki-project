<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>図なし教材</title>
  <link rel="icon" href="/anki-project/assets/img/favicon.png" type="image/png">
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --ink:#1f2937; --muted:#667085; --brand:#3b4675; --ok:#22c55e; --ng:#ef4444; --border:#e5e7eb; }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;color:var(--ink);background:var(--bg)}
    body{font-size:18px;line-height:1.7}
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(6px);background:rgba(255,255,255,.92);border-bottom:1px solid var(--border)}
    .wrap{max-width:960px;margin:0 auto;padding:14px 16px}
    .title{font-size:20px;font-weight:800}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:.95em}
    .range{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:.95em}
    .btn{cursor:pointer;border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;font-size:1rem}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.ghost{background:transparent}
    main{max-width:960px;margin:12px auto 24px;padding:0 16px;display:grid;gap:14px}
    .qcard{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;display:grid;gap:10px}
    .qtop{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .qid{font-weight:800;letter-spacing:.02em}
    .note{color:var(--muted);font-size:.95em}
    .qtext{font-size:1.1em}
    .choices{display:grid;gap:8px}
    .choiceRow{display:grid;gap:8px}
    .choice{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer;user-select:none}
    .choice input{width:20px;height:20px;margin-top:2px}
    .result{display:none;border:1px dashed var(--border);background:#f8fafc;border-radius:12px;padding:10px}
    .qcard.correct{border-color:#bbf7d0;background:#f0fff4}
    .qcard.wrong{border-color:#fecaca;background:#fff5f5}
    .chips{display:inline-flex;gap:6px;align-items:center}
    .chip{font-size:.9em;padding:2px 10px;border-radius:999px;border:1px solid var(--border);background:#f1f5f9}
    .chip.ok{background:#dcfce7;border-color:#86efac}
    .chip.bad{background:#fee2e2;border-color:#fca5a5}
    .empty{color:#64748b;background:#fff;border:1px dashed var(--border);padding:14px;border-radius:12px}
    footer{text-align:center;color:#94a3b8;font-size:.95em;padding:6px 0 20px}
    .ckey{font-weight:700;margin-right:.25em}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title" id="pageTitle">図なし教材</div>
      <div class="toolbar">
        <span class="pill"><input type="checkbox" id="shuffle"> <label for="shuffle">ならべかえ</label></span>
        <span class="pill"><input type="checkbox" id="voice"> <label for="voice">よみあげ</label></span>
        <span class="pill"><input type="checkbox" id="review"> <label for="review">復習モード（誤答のみ）</label></span>
        <span class="range"><label for="rate">速さ</label>
          <input type="range" id="rate" min="0.6" max="1.4" step="0.1" value="1">
          <span id="rateDisp">1.0×</span>
        </span>
        <button class="btn" id="speakAllBtn">全体をよむ</button>
        <button class="btn" id="speakWrongBtn">まちがいだけよむ</button>
        <button class="btn ghost" id="pauseBtn">⏸ 一時停止</button>
        <button class="btn ghost" id="resumeBtn">▶ 再開</button>
        <button class="btn ghost" id="stopBtn">⏹ 停止</button>
        <button class="btn" id="resetBtn">りれきをリセット</button>
      </div>
    </div>
  </header>

  <main id="list"></main>
  <footer>えらんで答えよう。間違えた問題だけを「復習モード」で解くことができます。</footer>

  <script>
  const qs = new URLSearchParams(location.search);
  const dataUrl = qs.get('data');
  const title = qs.get('title') || '図なし教材';
  document.getElementById('pageTitle').textContent = title;

  const els = {
    list: document.getElementById('list'),
    shuffle: document.getElementById('shuffle'),
    voice: document.getElementById('voice'),
    review: document.getElementById('review'),
    rate: document.getElementById('rate'),
    rateDisp: document.getElementById('rateDisp'),
    reset: document.getElementById('resetBtn'),
  };

  const key = (k)=>`anki-noimg:${dataUrl}:${k}`;
  let results = JSON.parse(localStorage.getItem(key('results')) || '{}');

  fetch(dataUrl, { cache:'no-store' })
    .then(r=>r.json())
    .then(init)
    .catch(()=>alert('JSONの読み込みに失敗しました'));

  function normalizeItems(d){return Array.isArray(d.items)?d.items:[];}

  function init(json){
    let items = normalizeItems(json);
    render(items);
  }

  // ===== 修正版: isCorrectChoice =====
  function isCorrectChoice(item, idx){
    const answers = new Set((item.answers || []).map(String));
    const label = String.fromCharCode(0x30A2 + idx); // ア,イ,ウ,エ...
    let raw = item.choices ? item.choices[idx] : '';
    if (typeof raw === 'string' && /^[ア-エ]/.test(raw)) raw = raw.charAt(0);
    const candidates = [label, raw, String(idx)];
    return candidates.some(c => answers.has(c));
  }

  function render(items){
    els.list.innerHTML='';
    items.forEach(it=>{
      const card=document.createElement('section');
      card.className='qcard';
      card.dataset.id=it.id;

      const qtext=document.createElement('div');
      qtext.className='qtext';
      qtext.textContent=it.q;
      card.appendChild(qtext);

      if(Array.isArray(it.choices)){
        const grp=document.createElement('div');
        grp.className='choiceRow';
        it.choices.forEach((c,idx)=>{
          const label=String.fromCharCode(0x30A2+idx);
          const row=document.createElement('label');
          row.className='choice';
          row.dataset.key=label;
          row.innerHTML=`<input type="radio" name="q_${it.id}" value="${idx}">
                         <span class="ckey">${label}：</span>${c.replace(/^[ア-エ]：?/,'')}`;
          row.addEventListener('click',()=>onChoose(it,idx,card));
          grp.appendChild(row);
        });
        card.appendChild(grp);
      }

      const result=document.createElement('div');
      result.className='result';
      result.innerHTML=`<div>こたえ：<strong>${(it.answers||[]).join(' / ')}</strong></div>`;
      card.appendChild(result);

      els.list.appendChild(card);
    });
  }

  function onChoose(item, idx, card){
    const ok=isCorrectChoice(item,idx);
    results[item.id]=ok?'correct':'wrong';
    localStorage.setItem(key('results'),JSON.stringify(results));
    card.classList.toggle('correct',ok);
    card.classList.toggle('wrong',!ok);
  }

  els.reset.addEventListener('click',()=>{
    if(confirm('りれきをリセットしますか？')){
      results={};localStorage.setItem(key('results'),'{}');location.reload();
    }
  });
  </script>
</body>
</html>
